@inherits ComponentCore<GoogleAdSense>

@inject IJSRuntime JS

@if (!Navigation.BaseUri.Contains("localhost") && Settings is { ShowAdSense: true } && Principal?.AuthPaddle is not { IsPaidUser: true })
{
    <HeadContent>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5145928155833172" crossorigin="anonymous"></script>
    </HeadContent>
    <div style="text-align: center" @key="_instanceKey">
        <ins class="adsbygoogle google-ads" data-ad-client="ca-pub-@AdClientId" data-ad-slot="@(((long)Section).ToString())"></ins>
    </div>
    <style>
        ins.adsbygoogle[data-ad-status='unfilled'] {
            display: none !important;
        }
    </style>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
}

@code {
    [Parameter][EditorRequired] public AdUnit Section { get; set; } = AdUnit.Main;
    [Parameter][EditorRequired] public bool IsAuthenticated { get; set; }

    private Settings? Settings { get; set; }
    private AuthPrincipal? Principal { get; set; }

    private const string AdClientId = "5145928155833172";
    private readonly Guid _instanceKey = Guid.NewGuid();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            Settings = await CacheSettingsApi.GetSettings();
            Principal = await PrincipalApi.Get(IsAuthenticated);
            StateHasChanged();
        }
    }

    public enum AdUnit : long
    {
        Main = 7676349386,
        Profile = 3931182088
    }
}
