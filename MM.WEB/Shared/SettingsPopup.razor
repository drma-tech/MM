@using Button = MM.WEB.Resources.Button
@inherits ComponentCore<SettingsPopup>

@inject IJSRuntime JsRuntime

<MudDialog Style="width: 100%">
    <DialogContent>
        <MudGrid Class="mb-6">
            <MudItem xs="12">
                <MudSelect Value="@Language" ValueChanged="@((AppLanguage vl) => AppLanguageValueChanged(vl))" Label="@GlobalTranslations.AppLanguage"
                           HelperText="@GlobalTranslations.AppLanguageDesc" FullWidth="true">
                    @foreach (var item in appLanguages)
                    {
                        <MudSelectItem Value="@item">@item.GetName()</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudToggleGroup Value="DarkMode" ValueChanged="(bool vl) => DarkModeChanged(vl)" SelectionMode="SelectionMode.SingleSelection" Vertical="false" Color="Color.Primary">
                    <MudToggleItem Value="false">
                        <MudIcon Icon="@IconsFA.Solid.Icon("sun").Font" Title="@GlobalTranslations.LightMode" Class="me-1"></MudIcon>
                        @GlobalTranslations.LightMode
                    </MudToggleItem>
                    <MudToggleItem Value="true">
                        <MudIcon Icon="@IconsFA.Solid.Icon("moon").Font" Title="@GlobalTranslations.DarkMode" Class="me-1"></MudIcon>
                        @GlobalTranslations.DarkMode
                    </MudToggleItem>
                </MudToggleGroup>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => { MudDialog?.Close(); })">@Button.Close</MudButton>
    </DialogActions>
</MudDialog>

@code {

    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }

    private readonly AppLanguage[] appLanguages = Enum.GetValues<AppLanguage>();

    public AppLanguage Language { get; set; } = AppLanguage.en;
    public bool DarkMode { get; set; } = false;

    protected override async Task LoadEssentialDataAsync()
    {
        Language = await AppStateStatic.GetAppLanguage(null);
        DarkMode = await AppStateStatic.GetDarkMode(null) ?? false;
    }

    protected async Task AppLanguageValueChanged(AppLanguage value)
    {
        Language = value;

        await JsRuntime.InvokeAsync<string>("SetLocalStorage", "app-language", value.ToString());

        Navigation.NavigateTo(Navigation.GetUriWithQueryParameter("app-language", value.ToString()), true);
    }

    protected async Task DarkModeChanged(bool value)
    {
        DarkMode = value;

        await JsRuntime.InvokeAsync<string>("SetLocalStorage", "dark-mode", value.ToString()?.ToLower());

        AppStateStatic.ChangeDarkMode(value);
    }

}
